services:
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"   # REST + dashboard
      - "6334:6334"   # gRPC
    volumes:
      - qdrant_storage:/qdrant/storage
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
  redisinsight:
    image: redis/redisinsight:latest
    ports:
      - "8001:5540"
    depends_on:
      - redis
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
  mcp:
    build: .
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - FASTMCP_SERVER_AUTH=${FASTMCP_SERVER_AUTH}
      - FASTMCP_SERVER_AUTH_GITHUB_CLIENT_ID=${FASTMCP_SERVER_AUTH_GITHUB_CLIENT_ID}
      - FASTMCP_SERVER_AUTH_GITHUB_CLIENT_SECRET=${FASTMCP_SERVER_AUTH_GITHUB_CLIENT_SECRET}
      - FASTMCP_SERVER_AUTH_GITHUB_BASE_URL=${FASTMCP_SERVER_AUTH_GITHUB_BASE_URL}
      - DATA_DIR=/app/data
      - PDF_PATH=${PDF_PATH:-}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pdf_chunks}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - REDIS_SKIP_PROCESSED=${REDIS_SKIP_PROCESSED:-1}
      - STORE_PARTITIONS_DISK=${STORE_PARTITIONS_DISK:-1}
      - STORE_CHUNKS_DISK=${STORE_CHUNKS_DISK:-1}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - DENSE_MODEL=${DENSE_MODEL:-BAAI/bge-small-en-v1.5}
      - SPARSE_MODEL=${SPARSE_MODEL:-Qdrant/bm25}
      - CHUNK_SIZE=${CHUNK_SIZE:-1200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - UNSTRUCTURED_API_URL=${UNSTRUCTURED_API_URL:-https://api.unstructured.io}
      - UNSTRUCTURED_STRATEGY=${UNSTRUCTURED_STRATEGY:-hi_res}
      - UNSTRUCTURED_CHUNKING_STRATEGY=${UNSTRUCTURED_CHUNKING_STRATEGY:-basic}
      - UNSTRUCTURED_LANGUAGES=${UNSTRUCTURED_LANGUAGES:-}
      - CITATION_BASE_URL=${CITATION_BASE_URL:-}
      - CITATION_REF_PATH=${CITATION_REF_PATH:-/r/doc}
    volumes:
      - ./data:/app/data:ro
  resolver:
    build: .
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      - minio
      - redis
      - qdrant
    environment:
      - PYTHONPATH=/app/src
      - RESOLVER_HOST=0.0.0.0
      - RESOLVER_PORT=8080
      - LINK_RESOLVER_MODE=${LINK_RESOLVER_MODE:-presign}
      - CITATION_BASE_URL=${CITATION_BASE_URL:-}
      - CITATION_REF_PATH=${CITATION_REF_PATH:-/r/doc}
      - CDN_BASE_URL=${CDN_BASE_URL:-}
      - MINIO_ALL_BUCKETS=true
      - MINIO_ENDPOINT=minio:9000
      - MINIO_PRESIGN_ENDPOINT=${MINIO_PRESIGN_ENDPOINT:-minio.heley.uk}
      - MINIO_PRESIGN_SECURE=${MINIO_PRESIGN_SECURE:-1}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=0
      - MINIO_PRESIGN_EXPIRY_SECONDS=${MINIO_PRESIGN_EXPIRY_SECONDS:-3600}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pdf_chunks}
    command: -m mcp_research.resolver_app
  minio_ingest:
    build: .
    restart: unless-stopped
    depends_on:
      - minio
      - qdrant
      - redis
    environment:
      - PYTHONPATH=/app/src
      - MINIO_ENQUEUE_CELERY=${MINIO_ENQUEUE_CELERY:-1}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=0
      - MINIO_BUCKETS=${MINIO_BUCKETS:-}
      - MINIO_ALL_BUCKETS=${MINIO_ALL_BUCKETS:-0}
      - MINIO_SUFFIX=${MINIO_SUFFIX:-.pdf}
      - MINIO_EVENTS=${MINIO_EVENTS:-s3:ObjectCreated:*,s3:ObjectRemoved:*}
      - MINIO_SKIP_EXISTING=${MINIO_SKIP_EXISTING:-1}
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - DENSE_MODEL=${DENSE_MODEL:-BAAI/bge-small-en-v1.5}
      - SPARSE_MODEL=${SPARSE_MODEL:-Qdrant/bm25}
      - CHUNK_SIZE=${CHUNK_SIZE:-1200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - UNSTRUCTURED_API_URL=${UNSTRUCTURED_API_URL:-https://api.unstructured.io}
      - UNSTRUCTURED_STRATEGY=${UNSTRUCTURED_STRATEGY:-hi_res}
      - UNSTRUCTURED_CHUNKING_STRATEGY=${UNSTRUCTURED_CHUNKING_STRATEGY:-basic}
      - UNSTRUCTURED_LANGUAGES=${UNSTRUCTURED_LANGUAGES:-}
    command: minio_ingest.py
  celery:
    build: .
    restart: unless-stopped
    depends_on:
      - redis
    environment:
      - PYTHONPATH=/app/src
      - CELERY_BROKER_URL=${REDIS_URL:-redis://redis:6379/0}
      - CELERY_RESULT_BACKEND=${REDIS_URL:-redis://redis:6379/0}
      - CELERY_VISIBILITY_TIMEOUT=${CELERY_VISIBILITY_TIMEOUT:-3600}
      - DATA_DIR=/app/data
      - PDF_PATH=${PDF_PATH:-}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=0
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - REDIS_SKIP_PROCESSED=${REDIS_SKIP_PROCESSED:-1}
      - STORE_PARTITIONS_DISK=${STORE_PARTITIONS_DISK:-1}
      - STORE_CHUNKS_DISK=${STORE_CHUNKS_DISK:-1}
      - DENSE_MODEL=${DENSE_MODEL:-BAAI/bge-small-en-v1.5}
      - SPARSE_MODEL=${SPARSE_MODEL:-Qdrant/bm25}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - UNSTRUCTURED_API_URL=${UNSTRUCTURED_API_URL:-https://api.unstructured.io}
      - UNSTRUCTURED_STRATEGY=${UNSTRUCTURED_STRATEGY:-hi_res}
      - UNSTRUCTURED_CHUNKING_STRATEGY=${UNSTRUCTURED_CHUNKING_STRATEGY:-basic}
      - UNSTRUCTURED_LANGUAGES=${UNSTRUCTURED_LANGUAGES:-}
      - CHUNK_SIZE=${CHUNK_SIZE:-1200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
    volumes:
      - ./data:/app/data
    command: -m celery -A mcp_research.celery_app worker --loglevel=info
  flower:
    build: .
    restart: unless-stopped
    depends_on:
      - redis
      - celery
    environment:
      - PYTHONPATH=/app/src
      - CELERY_BROKER_URL=${REDIS_URL:-redis://redis:6379/0}
      - CELERY_RESULT_BACKEND=${REDIS_URL:-redis://redis:6379/0}
      - FLOWER_BASIC_AUTH=${FLOWER_BASIC_AUTH:-}
    ports:
      - "5555:5555"
    command: -m celery -A mcp_research.celery_app flower --port=5555
  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run --token ${CF_TUNNEL_TOKEN}
    depends_on: [mcp, minio, resolver]
    restart: unless-stopped

volumes:
  qdrant_storage:
  redis_data:
  minio_data:
