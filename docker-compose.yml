services:
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"   # REST + dashboard
      - "6334:6334"   # gRPC
    volumes:
      - qdrant_storage:/qdrant/storage
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
  redisinsight:
    image: redis/redisinsight:latest
    ports:  
      - "8001:5540"
    environment:
      - RI_PROXY_PATH=redisinsight
    depends_on:
      - redis
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
  mcp:
    build: .
    restart: unless-stopped
    environment:
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pdf_chunks}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - DENSE_MODEL=${DENSE_MODEL:-BAAI/bge-small-en-v1.5}
      - SPARSE_MODEL=${SPARSE_MODEL:-Qdrant/bm25}
      - CHUNK_SIZE=${CHUNK_SIZE:-1200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - UNSTRUCTURED_API_URL=${UNSTRUCTURED_API_URL:-https://api.unstructured.io}
      - UNSTRUCTURED_STRATEGY=${UNSTRUCTURED_STRATEGY:-hi_res}
      - UNSTRUCTURED_CHUNKING_STRATEGY=${UNSTRUCTURED_CHUNKING_STRATEGY:-basic}
      - UNSTRUCTURED_LANGUAGES=${UNSTRUCTURED_LANGUAGES:-}
      - CITATION_BASE_URL=${CITATION_BASE_URL:-http://localhost:8080}
      - CITATION_REF_PATH=${CITATION_REF_PATH:-/r/doc}
    volumes:
      - ./data:/app/data:ro
  resolver:
    build: .
    restart: unless-stopped
    depends_on:
      - minio
      - redis
      - qdrant
    environment:
      - PYTHONPATH=/app/src
      - RESOLVER_HOST=0.0.0.0
      - RESOLVER_PORT=8080
      - LINK_RESOLVER_MODE=${LINK_RESOLVER_MODE:-proxy}
      - CITATION_BASE_URL=${CITATION_BASE_URL:-http://localhost:8080}
      - CITATION_REF_PATH=${CITATION_REF_PATH:-/r/doc}
      - CDN_BASE_URL=${CDN_BASE_URL:-}
      - MINIO_ALL_BUCKETS=true
      - MINIO_ENDPOINT=minio:9000
      - MINIO_PRESIGN_ENDPOINT=${MINIO_PRESIGN_ENDPOINT:-localhost:9000}
      - MINIO_PRESIGN_SECURE=${MINIO_PRESIGN_SECURE:-0}
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=0
      - MINIO_PRESIGN_EXPIRY_SECONDS=${MINIO_PRESIGN_EXPIRY_SECONDS:-3600}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pdf_chunks}
    command: -m mcp_research.resolver_app

  dashboard:
    build: .
    restart: unless-stopped
    depends_on:
      - redis
      - qdrant
    environment:
      - PYTHONPATH=/app/src
      - DASHBOARD_HOST=0.0.0.0
      - DASHBOARD_PORT=8002
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - CITATION_BASE_URL=${CITATION_BASE_URL:-http://localhost:8080}
      - CITATION_REF_PATH=${CITATION_REF_PATH:-/r/doc}
    command: -m mcp_research.dashboard_app
  bibtex_ui:
    build: .
    restart: unless-stopped
    depends_on:
      - minio
      - redis
      - qdrant
    environment:
      - PYTHONPATH=/app/src
      - BIBTEX_UI_HOST=0.0.0.0
      - BIBTEX_UI_PORT=8003
      - QDRANT_URL=${QDRANT_URL:-http://qdrant:6333}
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pdf_chunks}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - BIBTEX_REDIS_PREFIX=${BIBTEX_REDIS_PREFIX:-bibtex}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=0
      - BIBTEX_MINIO_ALL_BUCKETS=${BIBTEX_MINIO_ALL_BUCKETS:-1}
      - BIBTEX_MINIO_SUFFIX=${BIBTEX_MINIO_SUFFIX:-.pdf}
    command: -m mcp_research.bibtex_ui_app
  docs:
    image: nginx:1.27-alpine
    restart: unless-stopped
    volumes:
      - ./docs/index.html:/usr/share/nginx/html/index.html:ro
      - ./docs/tool-documentation.md:/usr/share/nginx/html/tool-documentation.md:ro
      - ./README.md:/usr/share/nginx/html/README.md:ro
  reverse_proxy:
    image: nginx:1.27-alpine
    restart: unless-stopped
    depends_on:
      - mcp
      - resolver
      - dashboard
      - bibtex_ui
      - docs
      - redisinsight
      - minio
      - flower
    ports:
      - "8080:8080"
    volumes:
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/home.html:/usr/share/nginx/html/home.html:ro
  minio_ingest:
    build: .
    restart: unless-stopped
    depends_on:
      - minio
      - qdrant
      - redis
    environment:
      - PYTHONPATH=/app/src
      - MINIO_ENQUEUE_CELERY=${MINIO_ENQUEUE_CELERY:-1}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=0
      - MINIO_BUCKETS=${MINIO_BUCKETS:-}
      - MINIO_ALL_BUCKETS=${MINIO_ALL_BUCKETS:-0}
      - MINIO_SUFFIX=${MINIO_SUFFIX:-.pdf}
      - MINIO_EVENTS=${MINIO_EVENTS:-s3:ObjectCreated:*,s3:ObjectRemoved:*}
      - MINIO_SKIP_EXISTING=${MINIO_SKIP_EXISTING:-1}
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - DENSE_MODEL=${DENSE_MODEL:-BAAI/bge-small-en-v1.5}
      - SPARSE_MODEL=${SPARSE_MODEL:-Qdrant/bm25}
      - CHUNK_SIZE=${CHUNK_SIZE:-1200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - UNSTRUCTURED_API_URL=${UNSTRUCTURED_API_URL:-https://api.unstructured.io}
      - UNSTRUCTURED_STRATEGY=${UNSTRUCTURED_STRATEGY:-hi_res}
      - UNSTRUCTURED_CHUNKING_STRATEGY=${UNSTRUCTURED_CHUNKING_STRATEGY:-basic}
      - UNSTRUCTURED_LANGUAGES=${UNSTRUCTURED_LANGUAGES:-}
    command: mcp_cli.py minio-ingest
  celery:
    build: .
    restart: unless-stopped
    depends_on:
      - redis
    environment:
      - PYTHONPATH=/app/src
      - CELERY_BROKER_URL=${REDIS_URL:-redis://redis:6379/0}
      - CELERY_RESULT_BACKEND=${REDIS_URL:-redis://redis:6379/0}
      - CELERY_VISIBILITY_TIMEOUT=${CELERY_VISIBILITY_TIMEOUT:-3600}
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD:-minioadmin}
      - MINIO_SECURE=0
      - QDRANT_URL=http://qdrant:6333
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - DENSE_MODEL=${DENSE_MODEL:-BAAI/bge-small-en-v1.5}
      - SPARSE_MODEL=${SPARSE_MODEL:-Qdrant/bm25}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - UNSTRUCTURED_API_URL=${UNSTRUCTURED_API_URL:-https://api.unstructured.io}
      - UNSTRUCTURED_STRATEGY=${UNSTRUCTURED_STRATEGY:-hi_res}
      - UNSTRUCTURED_CHUNKING_STRATEGY=${UNSTRUCTURED_CHUNKING_STRATEGY:-basic}
      - UNSTRUCTURED_LANGUAGES=${UNSTRUCTURED_LANGUAGES:-}
      - CHUNK_SIZE=${CHUNK_SIZE:-1200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
    volumes:
      - ./data:/app/data
    command: -m celery -A mcp_research.celery_app worker --loglevel=info
  flower:
    build: .
    restart: unless-stopped
    depends_on:
      - redis
      - celery
    environment:
      - PYTHONPATH=/app/src
      - CELERY_BROKER_URL=${REDIS_URL:-redis://redis:6379/0}
      - CELERY_RESULT_BACKEND=${REDIS_URL:-redis://redis:6379/0}
      - FLOWER_BASIC_AUTH=${FLOWER_BASIC_AUTH:-}
    ports:
      - "5555:5555"
    command: -m celery -A mcp_research.celery_app flower --port=5555 --url_prefix=flower

volumes:
  qdrant_storage:
    external: true
    name: mcp-research_qdrant_storage
  redis_data:
    external: true
    name: mcp-research_redis_data
  minio_data:
    external: true
    name: mcp-research_minio_data
