services:
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"   # REST + dashboard
      - "6334:6334"   # gRPC
    volumes:
      - ./qdrant_storage:/qdrant/storage:z
  mcp:
    build: .
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - FASTMCP_SERVER_AUTH=${FASTMCP_SERVER_AUTH}
      - FASTMCP_SERVER_AUTH_GITHUB_CLIENT_ID=${FASTMCP_SERVER_AUTH_GITHUB_CLIENT_ID}
      - FASTMCP_SERVER_AUTH_GITHUB_CLIENT_SECRET=${FASTMCP_SERVER_AUTH_GITHUB_CLIENT_SECRET}
      - FASTMCP_SERVER_AUTH_GITHUB_BASE_URL=${FASTMCP_SERVER_AUTH_GITHUB_BASE_URL}
      - DATA_DIR=/app/data
      - PDF_PATH=${PDF_PATH:-}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pdf_chunks}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - CHUNK_SIZE=${CHUNK_SIZE:-1200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - UNSTRUCTURED_API_URL=${UNSTRUCTURED_API_URL:-https://api.unstructured.io}
      - UNSTRUCTURED_STRATEGY=${UNSTRUCTURED_STRATEGY:-hi_res}
      - UNSTRUCTURED_CHUNKING_STRATEGY=${UNSTRUCTURED_CHUNKING_STRATEGY:-basic}
      - UNSTRUCTURED_LANGUAGES=${UNSTRUCTURED_LANGUAGES:-}
    volumes:
      - ./data:/app/data:ro
  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run --token ${CF_TUNNEL_TOKEN}
    depends_on: [mcp]
    restart: unless-stopped
 
