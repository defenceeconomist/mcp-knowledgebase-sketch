services:
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"   # REST + dashboard
      - "6334:6334"   # gRPC
    volumes:
      - qdrant_storage:/qdrant/storage
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
  redisinsight:
    image: redis/redisinsight:latest
    ports:
      - "8001:5540"
    depends_on:
      - redis
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
  mcp:
    build: .
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - FASTMCP_SERVER_AUTH=${FASTMCP_SERVER_AUTH}
      - FASTMCP_SERVER_AUTH_GITHUB_CLIENT_ID=${FASTMCP_SERVER_AUTH_GITHUB_CLIENT_ID}
      - FASTMCP_SERVER_AUTH_GITHUB_CLIENT_SECRET=${FASTMCP_SERVER_AUTH_GITHUB_CLIENT_SECRET}
      - FASTMCP_SERVER_AUTH_GITHUB_BASE_URL=${FASTMCP_SERVER_AUTH_GITHUB_BASE_URL}
      - DATA_DIR=/app/data
      - PDF_PATH=${PDF_PATH:-}
      - QDRANT_HOST=qdrant
      - QDRANT_PORT=6333
      - QDRANT_COLLECTION=${QDRANT_COLLECTION:-pdf_chunks}
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
      - REDIS_PREFIX=${REDIS_PREFIX:-unstructured}
      - REDIS_SKIP_PROCESSED=${REDIS_SKIP_PROCESSED:-1}
      - STORE_PARTITIONS_DISK=${STORE_PARTITIONS_DISK:-1}
      - STORE_CHUNKS_DISK=${STORE_CHUNKS_DISK:-1}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}
      - DENSE_MODEL=${DENSE_MODEL:-BAAI/bge-small-en-v1.5}
      - SPARSE_MODEL=${SPARSE_MODEL:-Qdrant/bm25}
      - CHUNK_SIZE=${CHUNK_SIZE:-1200}
      - CHUNK_OVERLAP=${CHUNK_OVERLAP:-200}
      - UNSTRUCTURED_API_KEY=${UNSTRUCTURED_API_KEY:-}
      - UNSTRUCTURED_API_URL=${UNSTRUCTURED_API_URL:-https://api.unstructured.io}
      - UNSTRUCTURED_STRATEGY=${UNSTRUCTURED_STRATEGY:-hi_res}
      - UNSTRUCTURED_CHUNKING_STRATEGY=${UNSTRUCTURED_CHUNKING_STRATEGY:-basic}
      - UNSTRUCTURED_LANGUAGES=${UNSTRUCTURED_LANGUAGES:-}
    volumes:
      - ./data:/app/data:ro
  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run --token ${CF_TUNNEL_TOKEN}
    depends_on: [mcp]
    restart: unless-stopped

volumes:
  qdrant_storage:
  redis_data:
  minio_data:
