services:
  mcp:
    build: .
    ports:
      - "8000:8000"
    environment:
      - PORT=8000
      - DOCS_DIR=/docs
      - MCP_RESOURCE=https://mcp.heley.uk
      - KEYCLOAK_ISSUER=${KEYCLOAK_ISSUER}
      - KEYCLOAK_VERIFY_TLS=${KEYCLOAK_VERIFY_TLS:-1}
      - REQUIRED_SCOPES=${REQUIRED_SCOPES:-tools.read}

    volumes:
      - ./docs:/docs:ro
    command: ["uvicorn", "server:app", "--host", "0.0.0.0", "--port", "8000"]
    restart: unless-stopped

  keycloak-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      - POSTGRES_DB=keycloak
      - POSTGRES_USER=keycloak
      - POSTGRES_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
    volumes:
      - keycloak-db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    depends_on:
      keycloak-db:
        condition: service_healthy
    environment:
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN:-admin}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD:-admin}
      - KC_DB=postgres
      - KC_DB_USERNAME=keycloak
      - KC_DB_PASSWORD=${KEYCLOAK_DB_PASSWORD:-keycloak}
      - KC_DB_URL_HOST=keycloak-db
      - KC_DB_URL_DATABASE=keycloak
      - KC_PROXY_HEADERS=xforwarded
      - KC_HEALTH_ENABLED=true
      - KC_HTTP_ENABLED=true

    command: ["start-dev", "--hostname-strict=false", "--http-relative-path=/auth"]
    ports:
      - "8080:8080"
    restart: unless-stopped

  cloudflared:
    image: cloudflare/cloudflared:latest
    command: tunnel --no-autoupdate run --token ${CF_TUNNEL_TOKEN}
    depends_on: [mcp, keycloak]
    restart: unless-stopped

volumes:
  keycloak-db-data:
